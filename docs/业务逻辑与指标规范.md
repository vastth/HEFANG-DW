# 何方珠宝 - 业务逻辑与指标规范

> 业务背景 | 零售逻辑 | 库存体系 | 指标口径 | 术语表

---

## 📋 目录

1. [公司业务背景](#一公司业务背景)
2. [零售单业务逻辑](#二零售单业务逻辑)
3. [库存体系与云仓](#三库存体系与云仓)
4. [渠道与店仓编码](#四渠道与店仓编码)
5. [库存健康度指标](#五库存健康度指标)
6. [业务术语表](#六业务术语表)

---

## 一、公司业务背景

### 1.1 公司简介

- **公司名称**：广东何方珠宝有限公司（HEFANG）
- **主营业务**：珠宝首饰设计、生产、销售
- **核心品类**：项链、耳环、手链、戒指、头饰、胸针等
- **客单价**：300-2000元（轻奢饰品）
- **ERP系统**：伯俊ERP（Oracle数据库）

---

### 1.2 销售渠道

**线上渠道（电商）—— 主力，占比约70%：**
- 天猫旗舰店（主力）
- 抖音（主力）
- 京东
- 小红书
- 视频号
- 唯品会（特卖）
- 得物

**线下渠道 —— 约30%：**
- 全国48家云仓门店（可为电商发货）
- 其他线下专柜

---

### 1.3 仓库布局

```
┌─────────────────────────────────────────────────────┐
│                     库存分布                        │
├─────────────────────────────────────────────────────┤
│  中山总仓(001)    10.9万件    电商发货主仓          │
│  云仓(48家门店)   17.9万件    门店库存可电商发货    │
│  其他仓库         大量件      配件辅料仓、功能仓等  │
└─────────────────────────────────────────────────────┘
```

**⚠️ 重要**：算电商可售库存 = 总仓(001) + 云仓(IS_ALLO2OSTORAGE='Y')

---

### 1.4 业务节奏与数据更新

| 场景 | 更新频率 | 说明 |
|------|----------|------|
| 日常监控 | T+1 | 每天凌晨更新前一天数据 |
| 大促期间 | 4小时 | 618/双11等活动期间 |
| 库存预警 | T+1 | 每天早上8点更新 |

**会议确认**：日常T+1足够，珠宝非快消品，库存变化慢

---

## 二、零售单业务逻辑

### 2.1 M_RETAIL单据生成时机

**线下门店：**
- 销售单：收银买单时生成（TOT_AMT_ACTUAL > 0）
- 退货单：顾客退货时生成（TOT_AMT_ACTUAL < 0）

**线上电商：**
- 销售单：仓库点击**发货出库**时生成（TOT_AMT_ACTUAL > 0）
- 退货单：仓库**确认收货**后生成（TOT_AMT_ACTUAL < 0）
- ⚠️ 发货前退款：**不生成任何单据**

---

### 2.2 关键结论

```
⭐ M_RETAIL的销售数量 = 实际出库数量（不是订单数量）
⭐ 用于计算周转天数时，用"销售数量"而非"净销量"
⭐ 因为退货的货物也需要先从仓库发出去，消耗了库存周转
```

---

### 2.3 销售数量提取SQL

```sql
-- 销售数量（出库数量，正向单）
SUM(CASE WHEN r.TOT_AMT_ACTUAL > 0 THEN ri.QTY ELSE 0 END) AS 销售数量

-- 退货数量（入库数量，负向单）
SUM(CASE WHEN r.TOT_AMT_ACTUAL < 0 THEN ABS(ri.QTY) ELSE 0 END) AS 退货数量

-- 净销量 = 销售数量 - 退货数量
销售数量 - 退货数量 AS 净销量
```

---

### 2.4 核心指标口径

| 指标 | 计算公式 | 数据源 |
|------|----------|--------|
| 销售额 | SUM(TOT_AMT_ACTUAL) WHERE >0 | M_RETAIL |
| 销量 | SUM(QTY) WHERE TOT_AMT_ACTUAL>0 | M_RETAILITEM |
| 退货额 | SUM(ABS(TOT_AMT_ACTUAL)) WHERE <0 | M_RETAIL |
| 退货量 | SUM(ABS(QTY)) WHERE TOT_AMT_ACTUAL<0 | M_RETAILITEM |
| 净销售额 | 销售额 - 退货额 | |
| 客单价 | 销售额 / 订单数 | |
| 退货率 | 退货额 / 销售额 | |

---

## 三、库存体系与云仓

### 3.1 FA_STORAGE表字段说明

| 字段 | 含义 | 说明 |
|------|------|------|
| QTY | 库存数量 | 当前库存 |
| QTYVALID | 可用库存 | 扣除占用后 |
| QTYOCCUPY | 占用数量 | 被订单锁定 |
| QTYPURCHASEREM | 采购欠数/在途 | 已下单未到货数量 |

---

### 3.2 云仓机制（核心概念）

**什么是云仓：**
```
传统模式：线下门店库存只能门店卖
云仓模式：门店库存也可以给电商发货

好处：
- 提高库存周转
- 减少缺货
- 降低调拨成本
```

**如何识别云仓门店：**
```sql
-- C_STORE表中
IS_ALLO2OSTORAGE = 'Y'  -- 这个标识表示参与云仓
```

**何方珠宝云仓情况：**
- 云仓门店：48家
- 云仓库存：17.9万件
- 总仓库存：10.9万件
- **云仓比总仓还多！**

---

### 3.3 电商可售库存口径

**2026年1月13日会议确认**：

```sql
-- 电商可售库存 = 总仓 + 云仓
WHERE (s.CODE = '001' OR s.IS_ALLO2OSTORAGE = 'Y')
```

**为什么这样定**：
- 只算总仓：10.9万件
- 加上云仓：28.9万件
- 差异：+165%！
- 不加云仓会严重低估可售库存

---

### 3.4 库存分析常用SQL

```sql
-- 总仓+云仓库存汇总
SELECT
    SUM(fs.QTY) AS 总库存,
    SUM(CASE WHEN s.CODE = '001' THEN fs.QTY ELSE 0 END) AS 总仓库存,
    SUM(CASE WHEN s.IS_ALLO2OSTORAGE = 'Y' THEN fs.QTY ELSE 0 END) AS 云仓库存
FROM FA_STORAGE fs
LEFT JOIN C_STORE s ON fs.C_STORE_ID = s.ID
WHERE fs.ISACTIVE = 'Y'
    AND (s.CODE = '001' OR s.IS_ALLO2OSTORAGE = 'Y');
```

---

## 四、渠道与店仓编码

### 4.1 仓库编码规则

| 编码 | 类型 | 说明 |
|------|------|------|
| 001 | 总仓 | 中山总仓，电商主仓 |
| 002-020 | 功能仓 | 旧款仓、返修仓等 |
| RT*** | 门店 | 如RT001=广州K11 |
| DS*** | 电商虚拟店 | 如DS001=天猫 |

**筛选SQL：**
```sql
-- 总仓
WHERE s.CODE = '001'

-- 线下门店
WHERE s.CODE LIKE 'RT%'

-- 电商渠道
WHERE s.CODE LIKE 'DS%'

-- 总仓+云仓
WHERE (s.CODE = '001' OR s.IS_ALLO2OSTORAGE = 'Y')
```

---

### 4.2 主要电商渠道

| 渠道ID | 渠道名称 | 店仓编码 | 重要程度 |
|--------|----------|----------|----------|
| 11 | 天猫 | DS001 | ⭐⭐⭐⭐⭐ |
| 57 | 抖音 | DS009 | ⭐⭐⭐⭐⭐ |
| 28 | 京东 | DS002 | ⭐⭐⭐⭐ |
| 60 | 小红书 | DS006 | ⭐⭐⭐⭐ |
| 300 | 视频号 | DS024 | ⭐⭐⭐ |
| 19 | 唯品会 | DS010 | ⭐⭐⭐ |
| 85 | 得物 | DS015 | ⭐⭐⭐ |

---

## 五、库存健康度指标

### 5.1 口径范围

**库存范围：**
- 来源表：dws_inventory_daily
- 口径：中山总仓 + 云仓门店
  - store_code = '001' 或 is_cloud_store = 'Y'
- 日期：ETL当天（snapshot_date）

**销售范围：**
- 来源表：dws_sales_daily
- 口径：电商店仓 + 云仓门店
  - store_code LIKE 'DS%' 或 is_cloud_store = 'Y'
- 统计周期：
  - 近30天：date_id >= today-30
  - 近7天：date_id >= today-7

**SKU范围：**
- 来源表：dim_product
- 仅主销品：is_main_product = 'Y'

---

### 5.2 核心指标定义

| 指标 | 口径说明 | 计算方式 |
| --- | --- | --- |
| total_qty | 总库存 | 当日库存汇总（总仓+云仓） |
| warehouse_qty | 总仓库存 | 当日 store_code='001' 汇总 |
| cloud_qty | 云仓库存 | 当日 is_cloud_store='Y' 汇总 |
| purchase_rem_qty | 采购欠数 | 当日 qtypurchaserem 汇总 |
| sales_qty_30d | 近30天销量 | 近30天正单销量汇总 |
| sales_amt_30d | 近30天销售额 | SUM(dws_sales_daily.sales_amount) |
| sales_qty_7d | 近7天销量 | 近7天正单销量汇总 |
| return_qty_30d | 近30天退货量 | SUM(return_qty) |
| return_amount_30d | 近30天退货额 | SUM(return_amount) |
| daily_avg_sales | 30天日均销量 | sales_qty_30d / 30 |
| daily_avg_sales_7d | 7天日均销量 | sales_qty_7d / 7 |
| sales_velocity | 销售加速度 | (sales_qty_7d/7) / (sales_qty_30d/30) |
| turnover_days | 周转天数 | total_qty / (sales_qty_30d/30)，若 30天销量为0，则为 9999 |
| inventory_status | 库存状态 | 见下方规则 |
| suggest_qty | 建议补货 | 见下方公式 |
| sku_grade | S/A/B/C | 见下方规则 |

---

### 5.3 库存状态判定

| 条件 | 状态 |
| --- | --- |
| total_qty > 0 且 sales_qty_30d = 0 | 滞销 |
| 周转 < 30 | 紧急缺货 |
| 30 <= 周转 < 70 | 需补货 |
| 70 <= 周转 <= 90 | 正常 |
| 周转 > 90 | 库存过高 |

---

### 5.4 建议补货公式

```
suggest_qty = (90 - turnover_days) * daily_avg_sales - return_qty_30d - purchase_rem_qty
```

**补充说明：**
- 若 sales_qty_30d = 0 或 turnover_days >= 90，则 suggest_qty = 0
- 退货与采购欠数视作未来回补库存，需从建议补货中扣减
- **允许负数**：当suggest_qty < 0时，表示库存过剩（与Oracle逻辑一致）

---

### 5.5 SABC分级规则

- 评分口径：近30天销售额 sales_amt_30d
- 按 sales_amt_30d 降序计算累计占比（cumulative_ratio）

| 分级 | 规则 |
| --- | --- |
| S | cumulative_ratio < 0.30 |
| A | 0.30 <= cumulative_ratio < 0.70 |
| B | 0.70 <= cumulative_ratio < 0.90 |
| C | cumulative_ratio >= 0.90 或无销售 |

---

### 5.6 数据关联逻辑

**以库存表为主表**（与Oracle逻辑一致）：
```sql
FROM 库存汇总(总仓+云仓) AS 主表
LEFT JOIN 商品维度
LEFT JOIN 销售汇总(近30天)
```

- 包含所有有库存的主销品SKU（即使销售为0）
- 库存为0但有销售的SKU也会通过LEFT JOIN保留
- 不过滤QTY=0记录（FA_STORAGE中QTY=0仍表示该商品被管理）

---

## 六、业务术语表

### 6.1 商品相关

| 术语 | 定义 | 示例 |
|------|------|------|
| **SKU** | 最小库存单位，款号+颜色+尺码 | HFM001-金色-均码 |
| **款号** | 商品编码，M_PRODUCT.NAME | HFM03705864-4 |
| **品名** | 商品名称，M_PRODUCT.VALUE | 气泡方糖项链 |
| **吊牌价** | 标准零售价，PRICELIST | ¥598 |
| **主销品** | 核心珠宝品类 | 项链、耳环、手链等 |
| **辅销品** | 非核心品类 | 配件、辅料、道具 |
| **绝版款** | 停产但有库存 | 不再补货 |
| **经典款** | 长期在售的畅销款 | 常年保持库存 |

---

### 6.2 库存相关

| 术语 | 定义 | 计算 |
|------|------|------|
| **库存数量** | 当前可售库存 | FA_STORAGE.QTY |
| **可用库存** | 扣除占用后 | QTYVALID |
| **占用库存** | 被订单锁定 | QTYOCCUPY |
| **采购欠数** | 在途库存 | QTYPURCHASEREM |
| **云仓** | 门店库存可电商发货 | IS_ALLO2OSTORAGE='Y' |
| **周转天数** | 库存可卖多少天 | 库存 / 日均销量 |
| **动销率** | 有销售的SKU占比 | 有销SKU数 / 总SKU数 |
| **滞销** | 有库存无销售 | 库存>0 且 30天销售=0 |

---

### 6.3 销售相关

| 术语 | 定义 | 说明 |
|------|------|------|
| **销售额** | 实际收款金额 | TOT_AMT_ACTUAL > 0 |
| **吊牌金额** | 按吊牌价计算 | TOT_AMT_LIST |
| **销量/销售数量** | 出库数量 | 发货件数 |
| **退货额** | 退款金额 | TOT_AMT_ACTUAL < 0 |
| **净销售额** | 销售额-退货额 | |
| **客单价** | 平均每单金额 | 销售额 / 订单数 |
| **退货率** | 退货占比 | 退货额 / 销售额 |
| **折扣率** | 实际/吊牌 | 销售额 / 吊牌金额 |

---

### 6.4 指标阈值

| 术语 | 定义 | 阈值 |
|------|------|------|
| **紧急缺货** | 周转<30天 | 立即补货 |
| **需补货** | 30≤周转<70天 | 安排补货 |
| **正常** | 70≤周转≤90天 | 健康状态 |
| **库存过高** | 周转>90天 | 控制进货 |
| **A类SKU** | 贡献前30-70%销售 | 重点关注 |
| **B类SKU** | 贡献70-90%销售 | 常规管理 |
| **C类SKU** | 贡献后10%销售 | 考虑清仓 |

---

### 6.5 系统相关

| 术语 | 定义 | 说明 |
|------|------|------|
| **伯俊ERP** | 公司使用的ERP系统 | 底层Oracle |
| **M_RETAIL** | 零售单表 | 核心销售数据 |
| **FA_STORAGE** | 实时库存表 | 当前库存 |
| **M_DIM** | 维度表 | 类别/性质等属性 |
| **T+1** | 隔天更新 | 今天看昨天数据 |
| **ETL** | 数据同步 | 从Oracle到MySQL |

---

### 6.6 状态码

| 表 | 字段 | 值 | 含义 |
|----|------|-----|------|
| 通用 | ISACTIVE | Y | 有效 |
| 通用 | ISACTIVE | N | 无效/删除 |
| M_RETAIL | STATUS | 2 | 已审核 |
| M_RETAIL | TOT_AMT_ACTUAL | >0 | 销售单 |
| M_RETAIL | TOT_AMT_ACTUAL | <0 | 退货单 |

---

### 6.7 数据验证清单

每次分析前检查：
- [ ] ISACTIVE = 'Y' 加了吗？
- [ ] STATUS = 2 加了吗（零售单）？
- [ ] 日期范围对吗？
- [ ] 主销品类别筛选了吗？
- [ ] 仓库口径对吗（总仓+云仓）？

---

*文档版本: 2.0 | 更新日期: 2026-01-20 | 合并文档3、6、7、8、10、11、14*
