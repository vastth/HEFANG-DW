# 何方珠宝 - 问题排查手册

> 常见数据问题 | 处理方法 | 验证对账 | 故障排查

---

## 📋 目录

1. [销售数据问题](#一销售数据问题)
2. [库存数据问题](#二库存数据问题)
3. [维度关联问题](#三维度关联问题)
4. [性能问题](#四性能问题)
5. [数据验证方法](#五数据验证方法)

---

## 一、销售数据问题

### 1.1 SQL查出来的销售额和渠道后台对不上

**原因分析：**

| 差异原因 | 说明 | 处理 |
|----------|------|------|
| 时间口径 | M_RETAIL是发货时间，后台是下单时间 | 正常，不用处理 |
| 发货前退款 | 没生成M_RETAIL | 正常，这部分没出库 |
| 跨天发货 | 昨天下单今天发 | 对比时注意时间 |
| 状态筛选 | 没加STATUS=2 | 必须加！ |
| 类别筛选 | 没排除辅销品 | 必须加主销品ID |

**验证SQL：**
```sql
-- 检查是否漏了筛选条件
SELECT COUNT(*) 
FROM M_RETAIL 
WHERE ISACTIVE='Y' AND STATUS=2 AND BILLDATE=20260113;

-- 对比（不加STATUS）
SELECT COUNT(*) 
FROM M_RETAIL 
WHERE BILLDATE=20260113;
```

**允许差异范围：**
- 日销售额：±5%以内正常
- 月销售额：±3%以内正常

---

### 1.2 销售数量出现负数

**原因**：跨期退货，退货日期在统计期外

**处理**：用CASE WHEN分开计算
```sql
-- 正确做法
SUM(CASE WHEN TOT_AMT_ACTUAL > 0 THEN QTY ELSE 0 END) AS 销售数量,
SUM(CASE WHEN TOT_AMT_ACTUAL < 0 THEN ABS(QTY) ELSE 0 END) AS 退货数量

-- 错误做法
SUM(QTY) -- 这样会正负相抵
```

---

### 1.3 单据未筛选ISACTIVE和STATUS

**常见错误：**
```sql
-- 错误：会包含作废单、草稿单
SELECT * FROM M_RETAIL WHERE BILLDATE = 20260113;
```

**正确写法：**
```sql
-- 正确：只查有效已审核单据
SELECT * FROM M_RETAIL 
WHERE BILLDATE = 20260113
  AND ISACTIVE = 'Y'
  AND STATUS = 2;
```

---

## 二、库存数据问题

### 2.1 负库存

**检查SQL：**
```sql
SELECT * FROM FA_STORAGE 
WHERE QTY < 0 AND ISACTIVE = 'Y';
```

**原因**：系统bug或手工调整

**处理**：
- 记录异常，报告IT部门
- 不影响大盘分析
- 如需修正可用GREATEST(QTY, 0)

---

### 2.2 库存数量比ERP系统显示的少

**原因**：没加云仓

**处理**：确保用正确口径
```sql
-- 错误：只算总仓
WHERE s.CODE = '001'

-- 正确：总仓+云仓
WHERE (s.CODE = '001' OR s.IS_ALLO2OSTORAGE = 'Y')
```

---

### 2.3 FA_STORAGE中存在QTY=0的记录

**说明**：这是正常的！

**原因**：QTY=0表示该商品在仓库中曾经存在/被系统管理，但当前无库存

**处理**：
- ETL同步时**不要过滤**QTY=0的记录（与Oracle原逻辑一致）
- ads_inventory_health中以库存表为主表，保留这些记录便于分析缺货情况

---

### 2.4 库存金额异常

**原因**：PRICELIST为空或异常

**检查SQL：**
```sql
-- 检查价格异常
SELECT * FROM M_PRODUCT 
WHERE PRICELIST IS NULL OR PRICELIST <= 0
  AND ISACTIVE = 'Y';
```

**处理**：
- 联系商品部更新价格
- 临时用NVL/COALESCE处理
```sql
NVL(p.PRICELIST, 0) AS 吊牌价
```

---

## 三、维度关联问题

### 3.1 类别显示为空

**原因**：M_DIM4_ID为空或关联不上

**检查SQL：**
```sql
-- 检查未关联的商品
SELECT COUNT(*) 
FROM M_PRODUCT 
WHERE M_DIM4_ID IS NULL 
  AND ISACTIVE = 'Y';

-- 检查关联不上的
SELECT p.NAME, p.M_DIM4_ID
FROM M_PRODUCT p
LEFT JOIN M_DIM d ON p.M_DIM4_ID = d.ID
WHERE d.ID IS NULL 
  AND p.M_DIM4_ID IS NOT NULL
  AND p.ISACTIVE = 'Y';
```

**处理**：用NVL/COALESCE处理
```sql
NVL(d4.ATTRIBNAME, '未分类') AS 类别
```

---

### 3.2 店仓名称奇怪

**原因**：历史数据或测试数据

**处理**：排除测试店
```sql
-- 排除测试店仓
WHERE s.CODE NOT LIKE 'CS%'  -- CS开头是测试店
  AND s.ISACTIVE = 'Y'
```

---

## 四、性能问题

### 4.1 SQL执行很慢

**原因**：全表扫描

**处理方法：**

1. **必须加日期范围筛选**
```sql
-- 慢（全表扫描）
SELECT * FROM M_RETAIL;

-- 快（使用索引）
SELECT ID, BILLDATE, TOT_AMT_ACTUAL 
FROM M_RETAIL 
WHERE BILLDATE >= 20260101 
  AND ISACTIVE = 'Y';
```

2. **用索引字段（BILLDATE, M_PRODUCT_ID, C_STORE_ID）**

3. **避免SELECT ***
```sql
-- 慢
SELECT * FROM M_RETAILITEM;

-- 快
SELECT M_RETAIL_ID, M_PRODUCT_ID, QTY, TOT_AMT_ACTUAL
FROM M_RETAILITEM;
```

4. **避免OR，用IN代替**
```sql
-- 慢
WHERE M_DIM4_ID = 134 OR M_DIM4_ID = 142 OR M_DIM4_ID = 139

-- 快
WHERE M_DIM4_ID IN (134, 142, 139)
```

---

### 4.2 JOIN过多导致慢

**优化方法：**

1. **只JOIN必要的表**
2. **先筛选再JOIN**
```sql
-- 优化前
FROM M_PRODUCT p
LEFT JOIN M_DIM d4 ON p.M_DIM4_ID = d4.ID
WHERE d4.ATTRIBNAME = '项链';

-- 优化后
FROM M_PRODUCT p
WHERE p.M_DIM4_ID = 142  -- 直接用ID筛选
```

---

## 五、数据验证方法

### 5.1 日期处理问题

**常见错误：**
```sql
-- 错误：类型不对
WHERE BILLDATE = '2026-01-13'  
WHERE BILLDATE >= SYSDATE-30   
```

**正确写法：**
```sql
-- 正确
WHERE BILLDATE = 20260113
WHERE BILLDATE >= TO_NUMBER(TO_CHAR(SYSDATE-30, 'YYYYMMDD'))
```

---

### 5.2 聚合计算问题

**问题：周转天数为负**

**原因**：数据异常

**处理**：
```sql
CASE 
    WHEN 周转天数 < 0 THEN 9999 
    ELSE 周转天数 
END
```

---

### 5.3 数据对账方法

#### 5.3.1 销售额对账

**步骤1：提取ERP数据**
```sql
SELECT 
    r.BILLDATE AS 日期,
    s.NAME AS 渠道,
    SUM(CASE WHEN r.TOT_AMT_ACTUAL > 0 THEN r.TOT_AMT_ACTUAL ELSE 0 END) AS ERP销售额
FROM M_RETAIL r
LEFT JOIN C_STORE s ON r.C_STORE_ID = s.ID
WHERE r.ISACTIVE = 'Y' 
  AND r.STATUS = 2
  AND r.BILLDATE >= 20260101
  AND r.BILLDATE <= 20260131
  AND s.CODE LIKE 'DS%'
GROUP BY r.BILLDATE, s.NAME;
```

**步骤2：与渠道后台对比**
- 导出各渠道后台数据
- 按日期、渠道核对
- 差异<5%正常

**步骤3：差异分析**
- 退款未退货（ERP无记录）
- 跨天发货（时间差异）
- 单据未审核（未计入）

---

#### 5.3.2 库存对账

**方法1：抽样盘点**
```sql
-- 选取10个SKU
SELECT 
    p.NAME AS 商品编码,
    s.NAME AS 仓库,
    fs.QTY AS ERP库存
FROM FA_STORAGE fs
LEFT JOIN M_PRODUCT p ON fs.M_PRODUCT_ID = p.ID
LEFT JOIN C_STORE s ON fs.C_STORE_ID = s.ID
WHERE fs.ISACTIVE = 'Y'
  AND s.CODE = '001'
  AND ROWNUM <= 10
ORDER BY DBMS_RANDOM.VALUE;
```

**方法2：总数核对**
```sql
-- ERP总库存
SELECT SUM(QTY) AS 总库存
FROM FA_STORAGE fs
LEFT JOIN C_STORE s ON fs.C_STORE_ID = s.ID
WHERE fs.ISACTIVE = 'Y'
  AND (s.CODE = '001' OR s.IS_ALLO2OSTORAGE = 'Y');

-- 与实物盘点对比，差异<1%正常
```

---

#### 5.3.3 周转天数验证

**验证方法：**
```sql
-- 计算单个SKU的周转天数
SELECT 
    p.NAME AS 商品编码,
    -- 当前库存
    (SELECT SUM(QTY) 
     FROM FA_STORAGE fs2 
     LEFT JOIN C_STORE s2 ON fs2.C_STORE_ID = s2.ID
     WHERE fs2.M_PRODUCT_ID = p.ID
       AND fs2.ISACTIVE = 'Y'
       AND (s2.CODE = '001' OR s2.IS_ALLO2OSTORAGE = 'Y')
    ) AS 库存,
    -- 近30天销量
    (SELECT SUM(ri.QTY)
     FROM M_RETAILITEM ri
     LEFT JOIN M_RETAIL r ON ri.M_RETAIL_ID = r.ID
     LEFT JOIN C_STORE s ON r.C_STORE_ID = s.ID
     WHERE ri.M_PRODUCT_ID = p.ID
       AND r.TOT_AMT_ACTUAL > 0
       AND r.ISACTIVE = 'Y' AND r.STATUS = 2
       AND r.BILLDATE >= TO_NUMBER(TO_CHAR(SYSDATE-30, 'YYYYMMDD'))
       AND (s.CODE LIKE 'DS%' OR s.IS_ALLO2OSTORAGE = 'Y')
    ) AS 销量30天,
    -- 周转天数
    CASE 
        WHEN (SELECT SUM(ri.QTY) FROM ...) = 0 THEN 9999
        ELSE ROUND((SELECT SUM(QTY) FROM ...) / ((SELECT SUM(ri.QTY) FROM ...) / 30), 1)
    END AS 周转天数
FROM M_PRODUCT p
WHERE p.NAME = 'HFM03705864-4';  -- 具体款号
```

---

### 5.4 数据校验清单

**每次分析前检查：**
- [ ] ISACTIVE = 'Y' 加了吗？
- [ ] STATUS = 2 加了吗（零售单）？
- [ ] 日期范围对吗？
- [ ] 主销品类别筛选了吗？
- [ ] 仓库口径对吗（总仓+云仓）？
- [ ] 正负单分开统计了吗？
- [ ] 空值用NVL/COALESCE处理了吗？

---

### 5.5 数据异常预警规则

| 指标 | 正常范围 | 告警阈值 |
|------|----------|----------|
| 日销售额环比 | ±30%以内 | 变动>50% |
| 库存总数环比 | ±10%以内 | 变动>20% |
| 退货率 | <15% | >25% |
| 负库存SKU数 | <10个 | >50个 |
| ETL耗时 | <40分钟 | >60分钟 |

---

### 5.6 故障排查流程

**问题：数据对不上**

```
1. 检查筛选条件
   ├─ ISACTIVE = 'Y'
   ├─ STATUS = 2
   ├─ 类别ID IN (...)
   └─ 仓库口径

2. 检查时间范围
   ├─ 日期格式正确吗（NUMBER(8)）
   ├─ 时间范围合理吗
   └─ 跨天数据处理了吗

3. 检查JOIN逻辑
   ├─ 关联字段对吗
   ├─ LEFT/INNER JOIN用对了吗
   └─ 维度表关联上了吗

4. 检查聚合逻辑
   ├─ 正负单分开了吗
   ├─ 空值处理了吗
   └─ GROUP BY字段对吗

5. 查看日志
   ├─ ETL日志
   ├─ 错误日志
   └─ 系统日志
```

---

### 5.7 问题上报模板

```
问题描述：
- 数据类型：销售/库存/其他
- 异常表现：具体数据不对
- 影响范围：全部/部分渠道/某些SKU
- 发现时间：YYYY-MM-DD HH:MM

初步排查：
- 已检查项：
  □ 筛选条件
  □ 时间范围
  □ JOIN逻辑
  □ 聚合计算
- 排查结果：

需要支持：
- 是否需要重跑ETL
- 是否需要检查Oracle
- 是否需要业务部门确认
```

---

*遇到数据对不上，先检查筛选条件，80%的问题出在这*

*文档版本: 2.0 | 更新日期: 2026-01-20 | 合并文档13、18*
